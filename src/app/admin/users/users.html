<mat-card class="users-card">
  <mat-card-header>
    <mat-card-title>All Users</mat-card-title>
    <mat-card-subtitle>Manage registered users (admin only)</mat-card-subtitle>
  </mat-card-header>

  <mat-card-content>
    <div class="filters">
      <mat-form-field appearance="outline" class="filter-field">
        <mat-label>Filter users</mat-label>
        <input
          matInput
          [ngModel]="searchTerm"
          (ngModelChange)="applyFilter($event)"
        />
        <button
          mat-icon-button
          matSuffix
          aria-label="clear"
          (click)="applyFilter('')"
        >
          <mat-icon>clear</mat-icon>
        </button>
        <mat-icon matSuffix>search</mat-icon>
      </mat-form-field>

      <mat-form-field appearance="outline" class="w120">
        <mat-label>User Type</mat-label>
        <mat-select
          [(ngModel)]="adminFilter"
          (selectionChange)="updateFilter()"
        >
          <mat-option value="all">All</mat-option>
          <mat-option value="admin">Admin</mat-option>
          <mat-option value="user">User</mat-option>
        </mat-select>
      </mat-form-field>

      <mat-form-field appearance="outline" class="w100">
        <mat-label>Age Min</mat-label>
        <input
          matInput
          type="number"
          [(ngModel)]="ageMin"
          (ngModelChange)="updateFilter()"
        />
      </mat-form-field>
      <mat-form-field appearance="outline" class="w100">
        <mat-label>Age Max</mat-label>
        <input
          matInput
          type="number"
          [(ngModel)]="ageMax"
          (ngModelChange)="updateFilter()"
        />
      </mat-form-field>

      <mat-form-field appearance="outline" class="w120">
        <mat-label>Flats Min</mat-label>
        <input
          matInput
          type="number"
          [(ngModel)]="flatsMin"
          (ngModelChange)="updateFilter()"
        />
      </mat-form-field>
      <mat-form-field appearance="outline" class="w120">
        <mat-label>Flats Max</mat-label>
        <input
          matInput
          type="number"
          [(ngModel)]="flatsMax"
          (ngModelChange)="updateFilter()"
        />
      </mat-form-field>
    </div>

    <div class="table-container">
      <table
        mat-table
        [dataSource]="dataSource"
        matSort
        class="mat-elevation-z2"
      >
        <!-- Name -->
        <ng-container matColumnDef="name">
          <th mat-header-cell *matHeaderCellDef mat-sort-header>Name</th>
          <td mat-cell *matCellDef="let u">
            <div class="name">{{ u.firstName }} {{ u.lastName }}</div>
          </td>
        </ng-container>

        <!-- Email -->
        <ng-container matColumnDef="email">
          <th mat-header-cell *matHeaderCellDef mat-sort-header>Email</th>
          <td mat-cell *matCellDef="let u">
            <span class="email">{{ u.email }}</span>
          </td>
        </ng-container>

        <!-- User Type（チップ廃止→CSSバッジ） -->
        <ng-container matColumnDef="isAdmin">
          <th mat-header-cell *matHeaderCellDef mat-sort-header>User Type</th>
          <td mat-cell *matCellDef="let u">
            <span
              class="role-badge"
              [class.admin]="u.isAdmin"
              [class.user]="!u.isAdmin"
            >
              {{ u.isAdmin ? 'Admin' : 'User' }}
            </span>
          </td>
        </ng-container>

        <!-- Flats -->
        <ng-container matColumnDef="flats">
          <th mat-header-cell *matHeaderCellDef mat-sort-header>Flats</th>
          <td mat-cell *matCellDef="let u">{{ u.flatsCount || 0 }}</td>
        </ng-container>

        <!-- Profile -->
        <ng-container matColumnDef="profile">
          <th mat-header-cell *matHeaderCellDef>Profile</th>
          <td mat-cell *matCellDef="let u">
            <button
              mat-stroked-button
              color="primary"
              (click)="openProfile(u.uid)"
            >
              <mat-icon>person</mat-icon>&nbsp;Open Profile
            </button>
          </td>
        </ng-container>
        <!-- Actions -->
        <ng-container matColumnDef="actions">
          <th mat-header-cell *matHeaderCellDef>Actions</th>
          <td mat-cell *matCellDef="let u" class="nowrap">
            <button
              mat-button
              color="primary"
              *ngIf="!u.isAdmin"
              (click)="grantAdmin(u)"
            >
              Grant admin
            </button>
            <button
              mat-button
              color="warn"
              *ngIf="u.isAdmin"
              (click)="revokeAdmin(u)"
            >
              Revoke admin
            </button>
            <button mat-stroked-button color="warn" (click)="removeUser(u)">
              Remove
            </button>
          </td>
        </ng-container>

        <!-- Rows -->
        <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
        <tr mat-row *matRowDef="let row; columns: displayedColumns"></tr>

        <!-- データ0件時 -->
        <tr class="empty-row" *matNoDataRow>
          <td colspan="5">No users found. Try a different filter.</td>
        </tr>
      </table>
    </div>

    <!-- ページャ -->
    <mat-paginator
      [pageSizeOptions]="[5,10,25]"
      showFirstLastButtons
    ></mat-paginator>
  </mat-card-content>
</mat-card>
